# -*- coding: utf-8 -*-
"""LendingClubLoanPrediction.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/10FeOwt8qieoUSTeViUcO-6yu1kscXQZM

![image.png](data:image/png;base64,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)

LendingClub is a US peer-to-peer lending company, headquartered in San Francisco, California. It was the first peer-to-peer lender to register its offerings as securities with the Securities and Exchange Commission (SEC), and to offer loan trading on a secondary market. Lending Club operates an online lending platform that enables borrowers to obtain a loan, and investors to purchase notes backed by payments made on loans.

In this project, I will use supervised learning models to identify whether the LC loan will be default in the future and make a prediction of their loan interest rate.

# Part 0: Setup Google Drive Environment and Load Data
"""

import pandas as pd
import numpy as np

from tabulate import tabulate

from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split

from pydrive.auth import GoogleAuth
from pydrive.drive import GoogleDrive
from google.colab import auth
from oauth2client.client import GoogleCredentials

import seaborn as sns
import matplotlib.pyplot as plt

from sklearn.preprocessing import OneHotEncoder
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import RandomForestClassifier
from sklearn.neighbors import KNeighborsClassifier 
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import classification_report,confusion_matrix
from sklearn import model_selection
from sklearn.svm import SVC
from sklearn.neural_network import MLPClassifier
from sklearn.metrics import classification_report,confusion_matrix

auth.authenticate_user()
gauth = GoogleAuth()
gauth.credentials = GoogleCredentials.get_application_default()
drive = GoogleDrive(gauth)

link = 'https://drive.google.com/open?id='
fluff, id = link.split('=')
file = drive.CreateFile({'id':id}) 
file.GetContentFile('loan-clean-version.csv')

"""load data"""

LC_df  = pd.read_csv('loan-clean-version.csv')
LC_df.head()

"""# Part 1: Data Exploration

# 1.1 Raw Data

Get to know the raw data by reading data dictionary

##full description of each fields:

LoanStatNew	 | Description
--- | ---
zip_code	|The first 3 numbers of the zip code provided by the borrower in the loan application.
addr_state	|The state provided by the borrower in the loan application
annual_inc|	The annual income provided by the borrower during registration.
collection_recovery_fee |	post charge off collection fee
collections_12_mths_ex_med |	Number of collections in 12 months excluding medical collections
delinq_2yrs	|The number of 30+ days past-due incidences of delinquency in the borrower’s credit file for the past 2 years
desc |	Loan description provided by the borrower
dti	| A ratio calculated using the borrower’s total monthly debt payments on the total debt obligations, excluding mortgage and the requested LC loan, divided by the borrower’s self-reported monthly income.
earliest_cr_line	|The month the borrower’s earliest reported credit line was opened
emp_length|	Employment length in years. Possible values are between 0 and 10 where 0 means less than one year and 10 means ten or more years.
emp_title|	The job title supplied by the Borrower when applying for the loan.
fico_range_high	|The upper boundary of range the borrower’s FICO belongs to.
fico_range_low|	The lower boundary of range the borrower’s FICO belongs to.
funded_amnt |	The total amount committed to that loan at that point in time.
funded_amnt_inv|	The total amount committed by investors for that loan at that point in time.
grade |	LC assigned loan grade
home_ownership|	The home ownership status provided by the borrower during registration. Our values are: RENT, OWN, MORTGAGE, OTHER.
id |	A unique LC assigned ID for the loan listing.
initial_list_status |	The initial listing status of the loan. Possible values are – W, F
inq_last_6mths |	The number of inquiries by creditors during the past 6 months.
installment	| The monthly payment owed by the borrower if the loan originates.
int_rate |	Interest Rate on the loan
is_inc_v |	Indicates if income was verified by LC, not verified, or if the income source was verified
issue_d	 | The month which the loan was funded
last_credit_pull_d |	The most recent month LC pulled credit for this loan
last_fico_range_high |	The last upper boundary of range the borrower’s FICO belongs to pulled.
last_fico_range_low |	The last lower boundary of range the borrower’s FICO belongs to pulled.
last_pymnt_amnt	| Last total payment amount received
last_pymnt_d |	Last month payment was received
loan_amnt |	The listed amount of the loan applied for by the borrower. If at some point in time, the credit department reduces the loan amount, then it will be reflected in this value.
loan_status |	Current status of the loan
member_id |	A unique LC assigned Id for the borrower member.
mths_since_last_delinq	| The number of months since the borrower’s last delinquency.
mths_since_last_major_derog	| Months since most recent 90-day or worse rating
mths_since_last_record |	The number of months since the last public record.
next_pymnt_d	| Next scheduled payment date
open_acc	| The number of open credit lines in the borrower’s credit file.
out_prncp |	Remaining outstanding principal for total amount funded
out_prncp_inv	| Remaining outstanding principal for portion of total amount funded by investors
policy_code |	Publicly available policy_code=1, new products not publicly available policy_code=2
pub_rec	|Number of derogatory public records
purpose	| A category provided by the borrower for the loan request.
pymnt_plan |	Indicates if a payment plan has been put in place for the loan
recoveries |	post charge off gross recovery
revol_bal |	Total credit revolving balance
revol_util|	Revolving line utilization rate, or the amount of credit the borrower is using relative to all available revolving credit.
sub_grade |	LC assigned loan subgrade
term	| The number of payments on the loan. Values are in months and can be either 36 or 60.
title |	The loan title provided by the borrower
total_acc	| The total number of credit lines currently in the borrower’s credit file
total_pymnt	|Payments received to date for total amount funded
total_pymnt_inv |	Payments received to date for portion of total amount funded by investors
total_rec_int	| Interest received to date
total_rec_late_fee|	Late fees received to date
total_rec_prncp	| Principal received to date
url	| URL for the LC page with listing data.
"""

LC_df.info()

"""There are 9k data, emp_length has over 300 null data, 7 non-numerical features, loan_status is the target variable."""

LC_df.isnull().sum()

LC_df.nunique()

"""# 1.2 Missing data

处理missing value，emp_length:用相近annual_inc人的emp_length去replace null; 3 empty revol_util can just be deleted
"""

LC_df_nonull = LC_df.dropna(subset=["revol_util"])

LC_df_nonull.isnull().sum()

min(LC_df_nonull["annual_inc"]), max(LC_df_nonull["annual_inc"]), LC_df_nonull["annual_inc"].nunique()

"""按照（max-min）/#unique，将annual——inc分成1554个bucket"""

LC_df_nonull["annualInc_bucket"] = pd.cut(LC_df_nonull["annual_inc"], LC_df_nonull["annual_inc"].nunique(), precision=0)

LC_df_nonull.head()

"""根据annual incom bucket去groupby找到emp length的mean，用这个mean去fill emp length的na"""

LC_df_nonull["emp_length"] = LC_df_nonull["emp_length"].astype('str')

LC_df_nonull["emp_length"] = LC_df_nonull["emp_length"].str.extract('(\d*)')

LC_df_nonull.emp_length.value_counts()

LC_df_nonull.emp_length

LC_df_nonull.emp_length = pd.to_numeric(LC_df_nonull.emp_length)

LC_df_nonull.emp_length

LC_df_nonull.emp_length.value_counts()

LC_df_nonull["emp_length_helper"] = LC_df_nonull.groupby("annualInc_bucket")["emp_length"].transform(lambda x: x.fillna(x.mean()))

LC_df_nonull.emp_length_helper = LC_df_nonull.emp_length_helper.round()

LC_df_nonull.head()

LC_df_nonull.emp_length_helper.isnull().sum()

LC_df_nonull["emp_length"] = LC_df_nonull["emp_length"].fillna(LC_df_nonull["emp_length_helper"])

LC_df_nonull.emp_length.value_counts()

#LC_df_nonull.emp_length = pd.to_numeric(LC_df_nonull.emp_length)

#LC_df_nonull.emp_length = LC_df_nonull.emp_length/100000

#LC_df_nonull.emp_length = LC_df_nonull.emp_length.astype(int)

#LC_df_nonull.emp_length.value_counts()

LC_df_nonull = LC_df_nonull.dropna(subset=["emp_length"])

LC_df_nonull.loan_status.value_counts()

"""# 1.3 EDA

画出数值型特征的相关系数热力图
"""

sns.set()

numCol = []
for col in LC_df_nonull:
  if (LC_df_nonull[col]).dtype==np.float or (LC_df_nonull[col]).dtype==np.int:
    numCol.append(col)

numCol

len(numCol)

corr = LC_df_nonull[numCol].corr()
fig, ax = plt.subplots(figsize=(10,10))
ax = sns.heatmap(
    corr, 
    vmin=-1, vmax=1, center=0,
    cmap=sns.diverging_palette(10, 220, n=200),
    square=True
)
ax.set_xticklabels(
    ax.get_xticklabels(),
    rotation=45,
    horizontalalignment='right')

# explore purpose category
LC_df_nonull["purpose"].value_counts().sort_values().plot(kind = 'barh')

LC_df_nonull["loan_amnt"].value_counts()[:15].sort_values().plot(kind='barh', title="Loan Amount")

LC_df_nonull["home_ownership"].value_counts().plot(kind='barh', color='orange')

LC_df_nonull["emp_length"].value_counts().sort_values().plot(kind='barh', color='green')

#total loan amount issued by State
df_location = LC_df_nonull.filter(["addr_state", "loan_amnt"], axis = 1)
df_location = df_location.groupby("addr_state",).sum().reset_index()
df_location = df_location.sort_values("loan_amnt", ascending=False)
#df_location = df_location.sort_values("loan_amnt", ascending=True)
df_location.head()

import plotly.graph_objects as go

fig = go.Figure(data=go.Choropleth(
    locations=df_location['addr_state'], # Spatial coordinates
    z = df_location['loan_amnt'].astype(float), # Data to be color-coded
    locationmode = 'USA-states', # set of locations match entries in `locations`
    colorscale = 'Reds',
    colorbar_title = "USD",
))

fig.update_layout(
    title_text = 'Total amount issued by State',
    geo_scope='usa', # limited map scope to USA
)

fig.show()

plt.figure(figsize=(16, 6))
plt.subplot(1, 2, 1)
sns.countplot(x="grade", data= LC_df_nonull, order = LC_df_nonull['grade'].value_counts().index)

_,axss = plt.subplots(3,2, figsize=[15,20])
sns.countplot(x='loan_status', hue='term', data=LC_df_nonull, ax=axss[0][0])
sns.countplot(x='loan_status', hue='grade', data=LC_df_nonull, ax=axss[0][1])
sns.countplot(x='loan_status', hue='emp_length', data=LC_df_nonull, ax=axss[1][0])
sns.countplot(x='loan_status', hue='home_ownership', data=LC_df_nonull, ax=axss[1][1])
sns.countplot(x='loan_status', hue='verification_status', data=LC_df_nonull, ax=axss[2][0])
sns.countplot(x='loan_status', hue='purpose', data=LC_df_nonull, ax=axss[2][1])

"""# Part 2 Feature Preprocessing

One hot to categorical features
"""

catCol = []
for col in LC_df_nonull:
  if (LC_df_nonull[col]).dtype==np.object and col!="loan_status":
    catCol.append(col)

catCol

def OneHotEncoding(df, enc, categories):  
  transformed = pd.DataFrame(enc.transform(df[categories]).toarray(), columns=enc.get_feature_names(categories))
  return pd.concat([df.reset_index(drop=True), transformed], axis=1).drop(categories, axis=1)


enc_ohe = OneHotEncoder()
enc_ohe.fit(LC_df_nonull[['term',
 'grade',
 'home_ownership',
 'verification_status',
 'purpose',
 'addr_state']])
LC_df_nonull = OneHotEncoding(LC_df_nonull, enc_ohe, ['term',
 'grade',
 'home_ownership',
 'verification_status',
 'purpose',
 'addr_state'])
# for col in catCol:
#   categories = np.array(np.array(col))
#   enc_ohe.fit(LC_df_nonull[categories])
#   LC_df_nonull = OneHotEncoding(LC_df_nonull, enc_ohe, categories)

LC_df_nonull.head()

"""drop useless columns: id"""

LC_df_nonull = LC_df_nonull.drop(["id"], axis=1)
LC_df_nonull = LC_df_nonull.drop(["annualInc_bucket"], axis=1)
LC_df_nonull = LC_df_nonull.drop(["emp_length_helper"], axis=1)

"""drop features that are highly correlated with target"""

#drop_col = ["total_pymnt", "total_pymnt_inv", "total_rec_int", "total_rec_prncp"]
LC_df_nonull = LC_df_nonull.drop(["total_pymnt"], axis=1)
LC_df_nonull = LC_df_nonull.drop(["total_pymnt_inv"], axis=1)
LC_df_nonull = LC_df_nonull.drop(["total_rec_int"], axis=1)
LC_df_nonull = LC_df_nonull.drop(["total_rec_prncp"], axis=1)

"""Data Splitting"""

Y = LC_df_nonull["loan_status"]
X = LC_df_nonull.drop(["loan_status"], axis=1)

X_train, X_test, y_train, y_test = train_test_split(X, Y, random_state=888, test_size=.25)

"""Standardization"""

X_train.info()

scaler = StandardScaler()
scaler.fit(X_train)
X_train = scaler.transform(X_train)
X_test = scaler.transform(X_test)

"""# Part 3: Modeling

RandomForest/ Kneighbors/ LogisticRegression
"""

# Logistic Regression
classifier_logistic = LogisticRegression()

# K Nearest Neighbors
classifier_KNN = KNeighborsClassifier()

# Random Forest
classifier_RF = RandomForestClassifier()

classifier_logistic.fit(X_train, y_train)
y_pred = classifier_logistic.predict(X_test)
print(classification_report(y_test,y_pred))

classifier_KNN.fit(X_train, y_train)
y_pred = classifier_KNN.predict(X_test)
print(classification_report(y_test,y_pred))

classifier_RF.fit(X_train, y_train)
y_pred = classifier_RF.predict(X_test)
print(classification_report(y_test,y_pred))

"""Cross Validation"""

model_names = ['Logistic Regression','KNN','Random Forest']
model_list = [classifier_logistic, classifier_KNN, classifier_RF]
count = 0

for classifier in model_list:
    cv_score = model_selection.cross_val_score(classifier, X_train, y_train, cv=5)
    print(cv_score)
    print('Model accuracy of ' + model_names[count] + ' is ' + str(cv_score.mean()))
    count += 1

"""Logistic Regression has the best performance.

SVM
"""

classifier_SVC = SVC()

cv_score = model_selection.cross_val_score(classifier_SVC, X_train, y_train, cv=5)
print('Model accuracy of SVM is: ' + str(cv_score.mean()))

"""Neural Networks"""

mlp = MLPClassifier(hidden_layer_sizes=(30,30))
mlp.fit(X_train,y_train)
y_pred = mlp.predict(X_test)
print(classification_report(y_test,y_pred))

classifier_RF.fit(X, Y)
importances = classifier_RF.feature_importances_
indices = np.argsort(importances)[::-1]

# Print the feature ranking
print("Feature importance ranking by Random Forest Model:")
for ind in range(X.shape[1]):
  print ("{0} : {1}".format(X.columns[indices[ind]],round(importances[indices[ind]], 4)))

X_with_corr = X.copy()
scaler = StandardScaler()
X_l2 = scaler.fit_transform(X_with_corr)
LRmodel_l2 = LogisticRegression(penalty="l2", C = 0.1, solver='liblinear')
LRmodel_l2.fit(X_l2, Y)

indices = np.argsort(abs(LRmodel_l2.coef_[0]))[::-1]

print ("Logistic Regression (L2) Coefficients")
for ind in range(X_with_corr.shape[1]):
  print ("{0} : {1}".format(X_with_corr.columns[indices[ind]],round(LRmodel_l2.coef_[0][indices[ind]], 4)))
